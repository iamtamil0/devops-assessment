name: CI/CD Deployment Pipeline

on:
  push:
    branches:
        - main

jobs:
    build_and_push:
        runs-on: ubuntu-latest

        steps:
        - name: Checkout code
          uses: actions/checkout@v4

        - name: Login to DockerHub
          uses: docker/login-action@v2
          with:
            username: ${{ secrets.DOCKER_USERNAME }}
            password: ${{ secrets.DOCKER_TOKEN }}
        
        - name: Build Backend Image
          run: |
            docker build -t ${{ secrets.DOCKER_USERNAME }}/backend:latest ./backend

        - name: Build Frontend image
          run: |
            docker build -t ${{ secrets.DOCKER_USERNAME }}/frontend:latest ./frontend
        
        - name: Push images
          run: |
            docker push ${{ secrets.DOCKER_USERNAME }}/backend:Latest
            docker push ${{ secrets.DOCKER_USERNAME }}/frontend:Latest

    deploy:
        needs: build_and_push
        runs-on: ubuntu-Latest

        steps:
         - name: Deploy to Server
           uses: appleboy/ssh-action@v0.1.7
           with:
             host: ${{ secrets.SERVER_HOST }}
             username: ${{ secrets.SERVER_USER }}
             key: ${{ secrets.SERVER_SSH_KEY }}
             script: |
                docker pull ${{ secrets.DOCKER_USERNAME }}/backend:Latest
                docker pull ${{ secrets.DOCKER_USERNAME }}/frontend:Latest
                docker-compose down
                dcoker-compose up -d